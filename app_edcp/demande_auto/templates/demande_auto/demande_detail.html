{% extends 'dashboard/base/master.html' %}
{% load crispy_forms_tags %}
{% load custom_tags_filters %}
{% load compress %}
{% load static %}

{% block app_styles %}
  {% compress css %}
    <link type="text/x-scss" href="{% static 'forms.scss' %}" rel="stylesheet" media="screen">
    <link type="text/x-scss" href="{% static 'demande_auto/styles.scss' %}" rel="stylesheet" media="screen">
  {% endcompress %}
{% endblock %}

{% block custom_scripts %}
  {% comment %} 
    Script : désactivation des champs du formulaire pour empêcher la modification
  {% endcomment %}
  <script>
    $(document).ready(function (){
      $('#form-demande input').attr('disabled', true);
      $('#form-demande textarea').attr('disabled', true);
      $('#form-demande select').attr('disabled', true);
      $('span.asteriskField').toggle(false);
    });
  </script>
{% endblock %}


{% block content %}
  <div class="row mx-3 my-4">
    <div class="col">
      <div class="card custom-card">
        <div class="card-body small-padding">
          <h3 class="mb-3 card-title">Demande d'autorisation
            #<strong>{{ demande.num_demande }}</strong> :
            {{ demande.type_demande }}
          </h3>
          <div class="card-text">
            <span><i class="bi bi-building-fill custom-text-light"></i> {{ demande.organisation }} </span><br>
            <span><i class="bi bi-file-earmark-text-fill custom-text-light"></i> Objet : {{ demande.type_demande }} </span><br>
            <span><i class="bi bi-hash custom-text-light"></i> N° <strong>{{ demande.num_demande }}</strong> </span><br>
            <span><i class="bi bi-stopwatch-fill custom-text-light"></i> {{ demande.status|get_status_color|safe }} </span><br><br>
            
            {% if show_form_analyse %}
              <div id="row-actions" class="row">
                <div class="col">
                  <a href="{% url 'dashboard:demande_auto:detail' pk=demande.id %}" class="btn btn-light me-2">
                    <i class="bi bi-arrow-left"></i>
                    Retour
                  </a>
                  <button class="btn btn-primary me-2">Enregistrer et continuer</button>
                  <button class="btn btn-outline-primary me-2">Enregistrer et quitter</button>
                  {% if analyse.status == 'analyse_terminee' %}
                    <button class="btn btn-info me-2">Soumettre pour validation</button>
                  {% endif %}
                </div>
              </div>
            {% else %}
              <div id="row-actions" class="row">
                {% if request.user.is_staff %}
                  <div class="col">
                    <form method="post" id="change-status-form">
                      {% csrf_token %}
                      <div class="row">
                        <div class="col-7">
                          {{ form_status.status }}
                        </div>
                        <div class="col-5">
                          <button type="submit" class="btn btn-primary" name="form_status_submit">Modifier le statut</button>
                        </div>
                      </div>
                    </form>
                  </div>
                {% endif %}
                
                <div class="col">
                  {% if not request.user.is_staff %}
                    {% if not demande.is_locked %}
                      <a href="{% url 'dashboard:demande_auto:edit' pk=demande.id %}" class="btn btn-primary me-2">Modifier</a>
                      <button class="btn btn-success me-2">Soumettre la demande</button>
                      <button class="btn btn-danger me-2">Supprimer</button>
                    
                    {% else %}
                      <button class="btn btn-primary me-2" disabled>Modifier</a>
                      <button class="btn btn-success me-2" disabled>Soumettre la demande</button>
                      <button class="btn btn-danger me-2" disabled>Supprimer</button>
                    {% endif %}
                    
                    <button class="btn btn-light me-2 mb-2 float-end" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasHistorique" aria-controls="offcanvasHistorique">
                      Afficher l'historique
                    </button>
                    <button class="btn btn-light mb-2 me-2 float-end" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCommentaires" aria-controls="offcanvasCommentaires">
                      Commentaires
                    </button>
                  {% endif %}

                  {% if request.user.is_staff %}
                    {% if analyse_exists %}
                      <a href="{% url 'dashboard:demande_auto:analyse' pk=demande.id %}" class="btn btn-secondary me-2">Poursuivre l'analyse</a>
                    {% else %}
                      <a href="{% url 'dashboard:demande_auto:analyse' pk=demande.id %}" class="btn btn-info me-2">Commencer l'analyse</a>
                    {% endif %}
                    
                  {% endif %}
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mx-3 my-4">
    <div class="col-7">
      <div class="card custom-card" style="max-height: 800px; overflow: scroll;">
        <div class="card-header custom-text-light">
          Contenu du formulaire
        </div>
        <div class="card-body small-padding">
          {% comment %} <h3 class="text-hint mb-3 card-title"></h3> {% endcomment %}
          <div class="card-text mt-3">
            <form id="form-demande">
              {% csrf_token %}
              {{ raw_form|crispy }}
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="col-5">
      <div class="card mb-3 custom-card">
        <div class="card-header custom-text-light">
          Fichiers joints
        </div>
        <div class="card-body small-padding">
          <ul class="list-group list-group-flush">
            {% for file_field in demande|get_file_fields %}
              <li class="list-group-item">
                <strong class="custom-text-light">{{ file_field.verbose_name }} : </strong>
                  {{ demande|attr:file_field.name|get_fileinfos|safe }}
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
  

{% block commentaires %}
  {% include "demande/commentaires_demande.html" with demande=demande %}
{% endblock %}

<input id="action-parameter" style="display: none;" type="hidden" value="{{show_comments}}"> 

{% endblock content %}


